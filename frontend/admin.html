<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Timelytics</title>

  <!-- Unbounded font -->
  <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;600;800&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF (for client-side PDF export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Theme variables */
:root {
  --magenta: #FF00FF;
  --violet: #8B00FF;
  --neon: #00BFFF;
  --glass: rgba(255, 255, 255, 0.04);
  --muted: rgba(230, 238, 243, 0.68);
}

html,
body {
  height: 100%;
  font-family: 'Unbounded', system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
  background: #05020a;
  color: #eef2ff;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* ---------- Background: animated gradient waves + subtle particles ---------- */
.bg-layer {
  position: fixed;
  inset: 0;
  z-index: -60;
  pointer-events: none;
  background: linear-gradient(180deg, #04020a 0%, #070317 60%);
  overflow: hidden;
}

.wave {
  position: absolute;
  inset: -20% -10% auto -10%;
  height: 140%;
  background: radial-gradient(circle at 20% 30%, rgba(139, 0, 255, 0.12), transparent 12%),
    radial-gradient(circle at 80% 70%, rgba(0, 191, 255, 0.08), transparent 10%);
  filter: blur(80px);
  opacity: 0.9;
  animation: waveMove 22s linear infinite;
  mix-blend-mode: screen;
}

.wave.wave-2 {
  transform: translateY(8%) rotate(6deg);
  animation-duration: 30s;
  opacity: 0.85;
}

@keyframes waveMove {
  0% {
    transform: translateY(0) rotate(0deg)
  }
  50% {
    transform: translateY(-6%) rotate(5deg)
  }
  100% {
    transform: translateY(0) rotate(0deg)
  }
}

canvas#particles {
  position: fixed;
  inset: 0;
  z-index: -50;
  pointer-events: none;
  opacity: 0.7;
}

.ribbon {
  position: absolute;
  left: -5%;
  right: -5%;
  top: 20%;
  height: 420px;
  pointer-events: none;
  z-index: -55;
  opacity: 0.55;
  filter: blur(24px) saturate(120%);
  mix-blend-mode: screen;
}

/* ---------- Navbar (glass sausage) ---------- */
header.topbar {
  position: fixed;
  top: 10px;
  left: 0;
  right: 0;
  z-index: 50;
  display: flex;
  justify-content: center;
  padding: 0 1rem;
}

.sausage {
  width: min(1200px, calc(100% - 2rem));
  display: flex;
  align-items: center;
  gap: 1rem;
  justify-content: space-between;
  padding: 0.42rem 0.8rem;
  border-radius: 9999px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
  border: 1px solid rgba(255, 255, 255, 0.04);
  backdrop-filter: blur(8px);
  box-shadow: 0 8px 30px rgba(2, 6, 23, 0.45);
}

.brand {
  font-weight: 800;
  font-size: 1.05rem;
  background: linear-gradient(90deg, var(--neon), var(--violet), var(--magenta));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.navlinks {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.navlinks a {
  color: rgba(255, 255, 255, 0.92);
  font-weight: 600;
  padding: 0.35rem 0.4rem;
  position: relative;
  text-decoration: none;
  transition: transform 0.18s ease, color 0.18s ease;
}

.navlinks a::after {
  content: "";
  position: absolute;
  left: 50%;
  transform: translateX(-50%) scaleX(0);
  bottom: 5px;
  height: 2px;
  width: 70%;
  border-radius: 2px;
  background: linear-gradient(90deg, var(--neon), var(--violet), var(--magenta));
  box-shadow: 0 8px 26px rgba(138, 0, 255, 0.12);
  transition: transform 0.22s cubic-bezier(0.2, 0.9, 0.2, 1), opacity 0.2s;
  opacity: 0.95;
}

.navlinks a:hover {
  transform: translateY(-2px);
  color: #fff;
}

.navlinks a:hover::after {
  transform: translateX(-50%) scaleX(1);
}

.btn-logout {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.16);
  color: #ffffff;
  padding: 0.6rem 1rem;
  font-size: 0.95rem;
  border-radius: 12px;
  font-weight: 800;
  box-shadow: 0 6px 18px rgba(2, 6, 23, 0.45);
  transition: box-shadow 0.18s ease, transform 0.12s ease, background 0.12s ease;
  cursor: pointer;
  text-decoration: none;
}

.btn-logout:hover {
  background: linear-gradient(90deg, rgba(255, 40, 60, 0.10), rgba(255, 40, 60, 0.06));
  box-shadow: 0 10px 40px rgba(255, 40, 60, 0.12), 0 3px 12px rgba(255, 40, 60, 0.06);
  transform: translateY(-3px);
}

/* ---------- Hero / header ---------- */
.hero {
  padding-top: 96px;
  padding-bottom: 48px;
  text-align: center;
  position: relative;
}

.hero h1 {
  font-size: clamp(1.8rem, 4.2vw, 3rem);
  font-weight: 800;
  line-height: 1.02;
  background: linear-gradient(90deg, var(--neon), var(--violet), var(--magenta));
  -webkit-background-clip: text;
  color: transparent;
  text-shadow: 0 6px 28px rgba(138, 0, 255, 0.06);
}

.hero p {
  color: var(--muted);
  margin-top: 0.6rem;
  max-width: 880px;
  margin-left: auto;
  margin-right: auto;
  font-size: 1rem;
}

/* ---------- Main cards grid ---------- */
.cards {
  max-width: 1200px;
  margin: 32px auto 56px;
  padding: 0 1rem;
  display: grid;
  gap: 18px;
  grid-template-columns: 1fr;
}

@media (min-width: 768px) {
  .cards {
    grid-template-columns: repeat(2, 1fr);
  }
}

.card {
  position: relative;
  overflow: hidden;
  border-radius: 14px;
  padding: 20px;
  min-height: 140px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.015), rgba(255, 255, 255, 0.01));
  border: 1px solid rgba(255, 255, 255, 0.04);
  backdrop-filter: blur(8px);
  transition: transform 0.28s cubic-bezier(0.2, 0.9, 0.2, 1), box-shadow 0.28s ease;
}

.card::before {
  content: "";
  position: absolute;
  inset: -2px;
  background: linear-gradient(90deg, var(--neon), var(--violet), var(--magenta));
  filter: blur(12px);
  opacity: 0.12;
  z-index: -1;
  pointer-events: none;
  border-radius: 16px;
}

.card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 30px 80px rgba(2, 6, 23, 0.6);
}

.card .icon {
  width: 54px;
  height: 54px;
  border-radius: 10px;
  display: inline-grid;
  place-items: center;
  color: #fff;
  font-weight: 800;
  background: linear-gradient(90deg, rgba(0, 191, 255, 0.12), rgba(138, 0, 255, 0.12));
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.45);
}

.card-cta-center {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 1rem;
}

.card-cta-center .cta-btn {
  display: inline-block;
  padding: 0.8rem 1.2rem;
  border-radius: 10px;
  font-weight: 800;
  background: linear-gradient(90deg, var(--neon), var(--violet));
  color: #05020a;
  box-shadow: 0 12px 40px rgba(138, 0, 255, 0.08);
  transition: transform 0.16s ease;
  cursor: pointer;
  text-align: center;
}

.card-cta-center .cta-btn:hover {
  transform: translateY(-4px) scale(1.02);
}

.reveal {
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.6s cubic-bezier(0.2, 0.9, 0.2, 1);
}

.reveal.visible {
  opacity: 1;
  transform: translateY(0);
}

/* ---------- Analytics row (mini stat cards) ---------- */
.stats-row {
  max-width: 1200px;
  margin: 8px auto 28px;
  display: flex;
  gap: 12px;
  padding: 0 1rem;
  flex-wrap: wrap;
  justify-content: center;
}

.stat {
  min-width: 160px;
  flex: 1;
  max-width: 260px;
  padding: 12px;
  border-radius: 12px;
  text-align: left;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.012), rgba(255, 255, 255, 0.008));
  border: 1px solid rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(6px);
  transition: transform 0.18s ease, box-shadow 0.18s ease;
}

.stat:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 50px rgba(2, 6, 23, 0.45);
}

.stat .count {
  font-weight: 800;
  font-size: 1.25rem;
  color: var(--neon);
  background: linear-gradient(90deg, var(--neon), var(--violet));
  -webkit-background-clip: text;
  color: transparent;
}

/* ---------- Footer ---------- */
footer.site-footer {
  margin-top: 48px;
  padding: 28px 1rem 48px;
  text-align: center;
  color: var(--muted);
}

.footer-line {
  height: 2px;
  width: 100%;
  max-width: 900px;
  margin: 0 auto 12px;
  border-radius: 3px;
  background: linear-gradient(90deg, var(--neon), var(--violet), var(--magenta));
  box-shadow: 0 10px 30px rgba(138, 0, 255, 0.06);
}

/* Recent timetables area (admin) */
.recent-area {
  max-width: 1200px;
  margin: 18px auto 56px;
  padding: 1rem;
}

.recent-card {
  padding: 16px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
  border: 1px solid rgba(255, 255, 255, 0.04);
  color: #eef2ff;
}

.recent-card table {
  width: 100%;
  border-collapse: collapse;
  color: #05020a;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
}

.recent-card thead th {
  text-align: left;
  padding: 10px 12px;
  background: #f6f7fb;
  color: #0b0b0b;
  font-weight: 700;
  border-bottom: 1px solid #e6e9ef;
}

.recent-card tbody td {
  padding: 10px 12px;
  border-bottom: 1px solid #eee;
  color: #0b0b0b;
  font-size: 14px;
}

.recent-empty {
  padding: 22px;
  text-align: center;
  color: rgba(11, 11, 11, 0.6);
  background: #fff;
  border-radius: 8px;
}

/* ========== RESPONSIVE MEDIA QUERIES ========== */

/* Hide backgrounds on mobile */
@media (max-width: 768px) {
  .bg-layer {
    display: none !important;
  }

  .ribbon {
    display: none !important;
  }

  canvas#particles {
    display: none !important;
  }
}

/* Tablet: 769px - 1024px */
@media (min-width: 769px) and (max-width: 1024px) {
  .sausage {
    padding: 0.4rem 0.7rem;
  }

  .cards {
    grid-template-columns: 1fr !important;
  }

  .stats-row {
    justify-content: space-between;
  }

  .stat {
    flex: 1 1 calc(50% - 6px);
  }
}

/* Mobile: 641px - 768px */
@media (max-width: 768px) {
  header.topbar {
    top: 6px;
    padding: 0 0.5rem;
  }

  .sausage {
    width: calc(100% - 1rem) !important;
    padding: 0.3rem 0.5rem !important;
    gap: 0.4rem !important;
  }

  .brand {
    font-size: 0.9rem !important;
  }

  .navlinks {
    display: none !important;
  }

  .hero {
    padding-top: 70px !important;
    padding-bottom: 24px !important;
  }

  .hero h1 {
    font-size: 1.8rem !important;
  }

  .hero p {
    font-size: 0.95rem !important;
  }

  .stats-row {
    flex-direction: column !important;
    gap: 10px !important;
    padding: 0 0.75rem !important;
  }

  .stat {
    min-width: unset !important;
    max-width: 100% !important;
    padding: 12px !important;
  }

  .stat .text-sm {
    font-size: 0.9rem !important;
  }

  .stat .count {
    font-size: 1.1rem !important;
  }

  .stat .text-xl {
    font-size: 1.4rem !important;
  }

  .cards {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
    padding: 0 0.75rem !important;
    margin: 20px auto 40px !important;
  }

  .card {
    padding: 16px !important;
    min-height: auto !important;
  }

  .card h3 {
    font-size: 1rem !important;
  }

  .card p {
    font-size: 0.9rem !important;
  }

  .card .icon {
    width: 48px !important;
    height: 48px !important;
  }

  .card-cta-center {
    margin-top: 0.75rem !important;
  }

  .card-cta-center .cta-btn {
    padding: 0.7rem 1rem !important;
    font-size: 0.9rem !important;
  }

  .btn-logout {
    padding: 0.45rem 0.75rem !important;
    font-size: 0.8rem !important;
    display: inline-flex !important;
  }

  .recent-area {
    margin: 12px auto 36px !important;
    padding: 0.75rem !important;
  }

  .recent-card {
    padding: 12px !important;
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }

  .recent-card table {
    font-size: 0.8rem !important;
  }

  .recent-card thead th,
  .recent-card tbody td {
    padding: 8px 6px !important;
  }

  footer.site-footer {
    padding: 20px 0.75rem 36px !important;
    font-size: 0.75rem !important;
  }

  .footer-line {
    max-width: 100% !important;
  }
}

/* Small Mobile: max-width 480px */
@media (max-width: 480px) {
  header.topbar {
    top: 4px !important;
    padding: 0 0.35rem !important;
  }

  .sausage {
    width: calc(100% - 0.7rem) !important;
    padding: 0.2rem 0.35rem !important;
    gap: 0.3rem !important;
  }

  .brand {
    font-size: 0.75rem !important;
  }

  .hidden.sm\:block {
    display: none !important;
  }

  .hero {
    padding-top: 60px !important;
    padding-bottom: 16px !important;
  }

  .hero h1 {
    font-size: 1.4rem !important;
  }

  .hero p {
    font-size: 0.8rem !important;
  }

  .stats-row {
    gap: 8px !important;
    padding: 0 0.5rem !important;
  }

  .stat {
    padding: 10px !important;
    min-width: unset !important;
  }

  .stat .text-sm {
    font-size: 0.75rem !important;
  }

  .stat .text-xl {
    font-size: 1.2rem !important;
  }

  .stat .count {
    font-size: 0.95rem !important;
  }

  .cards {
    gap: 10px !important;
    padding: 0 0.5rem !important;
    margin: 16px auto 32px !important;
  }

  .card {
    padding: 12px !important;
  }

  .card h3 {
    font-size: 0.9rem !important;
  }

  .card p {
    font-size: 0.8rem !important;
  }

  .card .icon {
    width: 40px !important;
    height: 40px !important;
  }

  .card-cta-center {
    margin-top: 0.6rem !important;
  }

  .card-cta-center .cta-btn {
    padding: 0.6rem 0.9rem !important;
    font-size: 0.8rem !important;
  }

  .btn-logout {
    padding: 0.4rem 0.6rem !important;
    font-size: 0.75rem !important;
    display: inline-flex !important;
  }

  .recent-area {
    padding: 0.5rem !important;
    margin: 10px auto 24px !important;
  }

  .recent-card {
    padding: 8px !important;
  }

  .recent-card table {
    font-size: 0.7rem !important;
  }

  .recent-card thead th,
  .recent-card tbody td {
    padding: 5px 3px !important;
  }

  input[type="time"],
  input[type="date"],
  input[placeholder],
  select {
    font-size: 1rem !important;
    padding: 0.6rem !important;
  }

  footer.site-footer {
    padding: 12px 0.5rem 20px !important;
    font-size: 0.65rem !important;
  }

  .footer-line {
    height: 1px !important;
  }
}
  </style>
</head>

<body>

  <!-- Background layers & ribbon -->
  <div class="bg-layer" aria-hidden="true">
    <div class="wave"></div>
    <div class="wave wave-2"></div>
  </div>

  <svg class="ribbon" viewBox="0 0 1600 420" preserveAspectRatio="none" aria-hidden="true">
    <defs>
      <linearGradient id="g1" x1="0" x2="1">
        <stop offset="0" stop-color="#00BFFF" stop-opacity="0.85" />
        <stop offset="0.5" stop-color="#8B00FF" stop-opacity="0.75" />
        <stop offset="1" stop-color="#FF00FF" stop-opacity="0.65" />
      </linearGradient>
    </defs>
    <path d="M0 200 C 200 80, 400 320, 600 200 S 1000 80, 1200 200 S 1400 320, 1600 200 L1600 420 L0 420 Z"
      fill="url(#g1)"></path>
  </svg>

  <!-- particles canvas -->
  <canvas id="particles" width="1920" height="1080" aria-hidden="true"></canvas>

  <!-- Navbar -->
  <header class="topbar" role="banner">
    <div class="sausage" role="navigation" aria-label="Main">
      <div class="flex items-center gap-4">
        <a href="#" class="brand" aria-label="Timelytics Home">Timelytics</a>
        <div class="hidden sm:block text-sm text-white/70">Admin Dashboard</div>
      </div>

      <nav class="navlinks" aria-label="Primary navigation">

      </nav>

      <div class="flex items-center gap-3">
        <!-- visible logout button, slightly larger and white-colored -->
        <a id="logoutBtn" href="index.html" class="btn-logout" title="Logout">Logout</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="container">
      <h1 class="reveal">Welcome, Admin</h1>
      <p class="reveal">Manage your institution’s schedules, faculty, and classrooms — effortlessly.</p>
      <div class="glow-divider reveal" role="presentation"
        style="height:3px;width:160px;margin:18px auto 0;border-radius:8px;background:linear-gradient(90deg,var(--neon),var(--violet),var(--magenta));box-shadow:0 12px 38px rgba(138,0,255,0.08);">
      </div>
    </div>
  </section>

  <!-- Analytics (kept as-is) -->
  <div class="stats-row">
    <div class="stat reveal">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-white/80">Total Faculty</div>
          <div class="count">128</div>
        </div>
        <div class="text-xl">🧑‍🏫</div>
      </div>
    </div>
    <div class="stat reveal">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-white/80">Active Timetables</div>
          <div class="count">24</div>
        </div>
        <div class="text-xl">📅</div>
      </div>
    </div>
    <div class="stat reveal">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-white/80">Pending Allocations</div>
          <div class="count">6</div>
        </div>
        <div class="text-xl">⚠️</div>
      </div>
    </div>
    <div class="stat reveal">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-white/80">Total Subjects</div>
          <div class="count">72</div>
        </div>
        <div class="text-xl">📘</div>
      </div>
    </div>
  </div>

  <!-- Main cards: only 2 cards retained, each with a centered CTA -->
  <main class="cards" role="main" aria-label="Main dashboard cards">
    <!-- CARD 1: Faculty Management (Create new timetable) -->
    <article class="card reveal" tabindex="0" aria-labelledby="c1">
      <div class="flex gap-4 items-start">
        <div class="icon">🧑‍🏫</div>
        <div class="flex-1">
          <h3 id="c1">Faculty Management</h3>
          <p class="mt-1">Add and manage faculty. Create a new timetable entry — useful when adding a new class or
            session.</p>

          <!-- Centered CTA: looks like button -->
          <div class="card-cta-center">
            <div id="btnCreateTT" class="cta-btn" role="button" aria-haspopup="dialog">Create Timetable</div>
          </div>

        </div>
      </div>
    </article>

    <!-- CARD 2: Classrooms (Edit today's / tomorrow's timetable) -->
    <article class="card reveal" tabindex="0" aria-labelledby="c2">
      <div class="flex gap-4 items-start">
        <div class="icon">🏫</div>
        <div class="flex-1">
          <h3 id="c2">Classrooms</h3>
          <p class="mt-1">Edit today's or tomorrow's timetable entries quickly — adjust times before classes start.</p>

          <!-- Centered CTA: looks like button -->
          <div class="card-cta-center">
            <div id="btnEditTT" class="cta-btn" role="button" aria-haspopup="dialog">Edit Timetable</div>
          </div>
        </div>
      </div>
    </article>
  </main>

  <!-- Recent timetables area shown to admin after create -->
  <section class="recent-area" aria-labelledby="recentTitle">
    <div class="recent-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3 id="recentTitle" style="margin:0;color:#eef2ff">Recently created timetables</h3>
        <div style="font-size:13px;color:var(--muted)">Shows latest created tables</div>
      </div>

      <div id="recentContainer">
        <div class="recent-empty">No timetables yet. Create one using the "Create Timetable" button above.</div>
      </div>

      <div class="mt-3 text-right">
        <button id="exportAdminPdf" class="btn-primary">Export PDF</button>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-line"></div>
    <div class="footer-text">© 2025 Timelytics | Built with ❤️ by TANTRIKS.</div>
  </footer>

  <!-- Modal root -->
  <div id="modalRoot" aria-hidden="true"></div>

  <!-- Scripts: reveal on scroll, particles, modal forms, simple mock API -->
  <script>
    // reveal on scroll
    (function () {
      const io = new IntersectionObserver((entries) => { entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); }); }, { threshold: 0.12 });
      document.querySelectorAll('.reveal').forEach(el => io.observe(el));
    })();

    // particles (same as before)
    (function () {
      const canvas = document.getElementById('particles');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      let w = canvas.width = innerWidth, h = canvas.height = innerHeight;
      const particles = Array.from({ length: 60 }, () => ({ x: Math.random() * w, y: Math.random() * h, r: Math.random() * 1.4 + 0.4, vx: (Math.random() - 0.5) * 0.25, vy: (Math.random() - 0.5) * 0.25, a: Math.random() * 0.6 + 0.15 }));
      addEventListener('resize', () => { w = canvas.width = innerWidth; h = canvas.height = innerHeight; });
      (function loop() { ctx.clearRect(0, 0, w, h); for (const p of particles) { p.x += p.vx; p.y += p.vy; if (p.x < 0) p.x = w; if (p.x > w) p.x = 0; if (p.y < 0) p.y = h; if (p.y > h) p.y = 0; ctx.beginPath(); ctx.fillStyle = `rgba(170,140,255,${p.a})`; ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill(); } requestAnimationFrame(loop); })();
    })();

    // small mock API helper (replace with real fetch)
    async function api(path, opts) {
      console.debug('API', path, opts || 'GET');
      // mock delay
      await new Promise(r => setTimeout(r, 420));
      // example responses for create and query
      if (path.startsWith('/api/timetables') && opts && opts.method === 'POST') return { ok: true, data: { id: 'tt_' + Date.now() } };
      if (path.startsWith('/api/timetables?date=')) {
        // return demo items for today/tomorrow
        const q = new URLSearchParams(path.split('?')[1]);
        const date = q.get('date');
        return {
          ok: true, data: [
            { id: 'c1', subject: 'Calculus', section: 'A', room: 'R101', start: '09:00', end: '10:00', faculty: 'Dr. Sharma' },
            { id: 'c2', subject: 'Algorithms', section: 'B', room: 'Lab 2', start: '10:30', end: '11:30', faculty: 'Prof. Rao' }
          ]
        };
      }
      if (path.startsWith('/api/timetables/') && opts && opts.method === 'PATCH') {
        return { ok: true, data: { success: true } };
      }
      return { ok: true, data: {} };
    }

    // Modal helper
    function showModal(html) {
      const root = document.getElementById('modalRoot');
      root.innerHTML = `<div class="fixed inset-0 z-60 flex items-start md:items-center justify-center p-4" role="dialog" aria-modal="true"><div class="w-full max-w-2xl">${html}</div><button class="absolute top-6 right-6 p-2 text-white/70" id="modalClose" aria-label="Close">✕</button></div>`;
      root.setAttribute('aria-hidden', 'false');
      document.getElementById('modalClose').addEventListener('click', closeModal);
    }
    function closeModal() { const root = document.getElementById('modalRoot'); root.innerHTML = ''; root.setAttribute('aria-hidden', 'true'); }

    /* ----------------- CREATE TIMETABLE (Button 1) - updated with dynamic rows ----------------- */
    document.getElementById('btnCreateTT').addEventListener('click', openCreateModal);
    function openCreateModal() {
      showModal(`
        <div class="card glass p-4 bg-black/40">
          <h3 class="text-lg font-bold">Create Timetable Entry</h3>
          <p class="text-sm text-white/70 mt-1">Add one or multiple subjects and faculties. College timings and date included.</p>

          <form id="createForm" class="mt-4 grid grid-cols-1 gap-3">

            <!-- College start/end times -->
            <div class="grid grid-cols-2 gap-3">
              <label class="block"><div class="text-xs text-white/70">College Start Time</div><input name="collegeStart" type="time" required class="w-full mt-1 p-2 rounded bg-white/3" /></label>
              <label class="block"><div class="text-xs text-white/70">College End Time</div><input name="collegeEnd" type="time" required class="w-full mt-1 p-2 rounded bg-white/3" /></label>
            </div>

            <!-- Date -->
            <label class="block"><div class="text-xs text-white/70">Date</div><input name="date" type="date" required class="w-full mt-1 p-2 rounded bg-white/3" /></label>

            <!-- Subjects: dynamic rows -->
            <div>
              <div class="flex items-center justify-between">
                <div class="text-xs text-white/70">Subjects</div>
                <button type="button" id="addSubjectRow" class="btn-ghost" title="Add subject">＋ Add Subject</button>
              </div>
              <div id="subjectsContainer" class="mt-2 space-y-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 subject-row">
                  <input name="subjectName[]" placeholder="Subject name" class="p-2 rounded bg-white/3" required />
                  <input name="subjectCode[]" placeholder="Subject code (optional)" class="p-2 rounded bg-white/3" />
                </div>
              </div>
            </div>

            <!-- Faculties: dynamic rows -->
            <div>
              <div class="flex items-center justify-between">
                <div class="text-xs text-white/70">Faculty</div>
                <button type="button" id="addFacultyRow" class="btn-ghost" title="Add faculty">＋ Add Faculty</button>
              </div>
              <div id="facultyContainer" class="mt-2 space-y-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 faculty-row">
                  <input name="facultyName[]" placeholder="Faculty name / ID" class="p-2 rounded bg-white/3" required />
                  <input name="facultyContact[]" placeholder="Contact (optional)" class="p-2 rounded bg-white/3" />
                </div>
              </div>
            </div>

            <!-- Class/room & times -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <input name="section" placeholder="Class / Section" class="p-2 rounded bg-white/3" required />
              <input name="room" placeholder="Room" class="p-2 rounded bg-white/3" required />
              <input name="duration" placeholder="Duration (minutes)" type="number" min="15" step="15" value="60" class="p-2 rounded bg-white/3" />
            </div>

            <!-- Submit -->
            <div class="flex items-center gap-3 mt-2">
              <button type="submit" class="btn-primary">Create</button>
              <button type="button" id="createCancel" class="btn-ghost">Cancel</button>
            </div>
          </form>

          <div id="createMsg" class="text-sm text-green-300 mt-3" aria-live="polite"></div>
        </div>
      `);

      // dynamic add/remove handlers
      const subjContainer = document.getElementById('subjectsContainer');
      const facContainer = document.getElementById('facultyContainer');

      document.getElementById('addSubjectRow').addEventListener('click', () => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 subject-row';
        row.innerHTML = `<input name="subjectName[]" placeholder="Subject name" class="p-2 rounded bg-white/3" required />
                         <div class="flex gap-2"><input name="subjectCode[]" placeholder="Subject code (optional)" class="p-2 rounded bg-white/3" />
                         <button type="button" class="btn-ghost remove-subject">Remove</button></div>`;
        subjContainer.appendChild(row);
        row.querySelector('.remove-subject').addEventListener('click', () => row.remove());
      });

      document.getElementById('addFacultyRow').addEventListener('click', () => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 faculty-row';
        row.innerHTML = `<input name="facultyName[]" placeholder="Faculty name / ID" class="p-2 rounded bg-white/3" required />
                         <div class="flex gap-2"><input name="facultyContact[]" placeholder="Contact (optional)" class="p-2 rounded bg-white/3" />
                         <button type="button" class="btn-ghost remove-faculty">Remove</button></div>`;
        facContainer.appendChild(row);
        row.querySelector('.remove-faculty').addEventListener('click', () => row.remove());
      });

      document.getElementById('createCancel').addEventListener('click', closeModal);

      document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.currentTarget;

        // collect multi-row fields
        const subjectNames = Array.from(form.querySelectorAll('input[name="subjectName[]"]')).map(i => i.value.trim()).filter(Boolean);
        const subjectCodes = Array.from(form.querySelectorAll('input[name="subjectCode[]"]')).map(i => i.value.trim());
        const facultyNames = Array.from(form.querySelectorAll('input[name="facultyName[]"]')).map(i => i.value.trim()).filter(Boolean);
        const facultyContacts = Array.from(form.querySelectorAll('input[name="facultyContact[]"]')).map(i => i.value.trim());

        const payload = {
          collegeStart: form.querySelector('input[name="collegeStart"]').value,
          collegeEnd: form.querySelector('input[name="collegeEnd"]').value,
          date: form.querySelector('input[name="date"]').value,
          subjects: subjectNames.map((name, idx) => ({ name, code: subjectCodes[idx] || '' })),
          faculties: facultyNames.map((name, idx) => ({ name, contact: facultyContacts[idx] || '' })),
          section: form.querySelector('input[name="section"]').value,
          room: form.querySelector('input[name="room"]').value,
          duration: form.querySelector('input[name="duration"]').value
        };

        // minimal validation
        if (!payload.date || !payload.collegeStart || !payload.collegeEnd) { alert('Please fill date and college timings'); return; }
        if (payload.subjects.length === 0) { alert('Add at least one subject'); return; }
        if (payload.faculties.length === 0) { alert('Add at least one faculty'); return; }

        // send to backend
        const resp = await api('/api/timetables', { method: 'POST', body: JSON.stringify(payload) });
        if (resp.ok) {
          document.getElementById('createMsg').textContent = 'Timetable entry created (demo).';
          setTimeout(() => { closeModal(); }, 900);
        } else alert('Failed to create entry');
      });
    }

    /* ----------------- EDIT TIMETABLE (Button 2) ----------------- */
    document.getElementById('btnEditTT').addEventListener('click', openEditModal);
    function openEditModal() {
      // limit date options to today & tomorrow
      const today = new Date();
      const t0 = today.toISOString().slice(0, 10);
      const t1 = new Date(today.getTime() + 86400000).toISOString().slice(0, 10);
      showModal(`
        <div class="card p-4">
          <h3 class="text-lg font-bold">Edit Timetable (Today / Tomorrow)</h3>
          <p class="text-sm text-white/70 mt-1">Select date (only today or tomorrow). Edit start/end times for entries that haven't started yet.</p>

          <div class="mt-3 flex gap-3 items-center">
            <select id="editDate" class="p-2 rounded bg-white/3" aria-label="Select date">
              <option value="${t0}">Today • ${t0}</option>
              <option value="${t1}">Tomorrow • ${t1}</option>
            </select>
            <button id="loadDate" class="btn-primary">Load</button>
            <button id="editCancel" class="btn-ghost">Close</button>
          </div>

          <div id="editList" class="mt-4 space-y-2 text-sm"></div>
        </div>
      `);

      document.getElementById('editCancel').addEventListener('click', closeModal);
      document.getElementById('loadDate').addEventListener('click', async () => {
        const date = document.getElementById('editDate').value;
        const res = await api(`/api/timetables?date=${date}`);
        const items = (res && res.data) || [];
        const container = document.getElementById('editList');
        container.innerHTML = items.map(it => `
          <div class="p-3 bg-white/3 rounded flex items-center justify-between">
            <div>
              <div class="font-semibold">${it.subject} • ${it.section} <span class="text-xs text-white/70">(${it.room})</span></div>
              <div class="text-xs text-white/70">Faculty: ${it.faculty}</div>
            </div>
            <div class="flex items-center gap-2">
              <input data-id="${it.id}" class="p-1 text-sm rounded bg-black/20" value="${it.start}" type="time" />
              <input data-id-end="${it.id}" class="p-1 text-sm rounded bg-black/20" value="${it.end}" type="time" />
              <button data-save="${it.id}" class="btn-primary text-sm">Save</button>
            </div>
          </div>
        `).join('');
        // attach save handlers
        container.querySelectorAll('button[data-save]').forEach(btn => {
          btn.addEventListener('click', async (ev) => {
            const id = btn.getAttribute('data-save');
            const start = container.querySelector(`input[data-id="${id}"]`).value;
            const end = container.querySelector(`input[data-id-end="${id}"]`).value;
            // basic validation
            if (end <= start) { alert('End must be after start'); return; }
            // re-check that class hasn't started (simple client-side check)
            const selectedDate = document.getElementById('editDate').value;
            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            if (selectedDate === todayStr) {
              const nowHM = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
              if (nowHM >= start) { return alert('Cannot edit classes that have already started.'); }
            }
            // send patch
            const resp = await api('/api/timetables/' + id, { method: 'PATCH', body: JSON.stringify({ start, end }) });
            if (resp.ok) { btn.textContent = 'Saved'; setTimeout(() => btn.textContent = 'Save', 900); } else alert('Failed to save');
          });
        });
      });

      // auto-load today initially
      document.getElementById('loadDate').click();
    }

    // logout demo
    document.getElementById('logoutBtn').addEventListener('click', () => alert('Logout (demo)'));

    // accessibility keyboard focus
    document.addEventListener('keyup', e => { if (e.key === 'Tab') document.body.classList.add('user-is-tabbing'); });

    /* ----------------- Admin recent timetables rendering/storage ----------------- */
    window.adminTimetables = JSON.parse(localStorage.getItem('adminTimetables') || '[]');

    function renderAdminTables() {
      const container = document.getElementById('recentContainer');
      if (!window.adminTimetables || window.adminTimetables.length === 0) {
        container.innerHTML = '<div class="recent-empty">No timetables yet. Create one using the "Create Timetable" button above.</div>';
        return;
      }

      // Build a simple table where each subject in a timetable becomes a row
      const rows = [];
      window.adminTimetables.forEach(tt => {
        const date = tt.date || '';
        const start = tt.collegeStart || '';
        const duration = Number(tt.duration || 60);
        // if subjects array exists, map them; otherwise fallback to one row
        if (Array.isArray(tt.subjects) && tt.subjects.length) {
          tt.subjects.forEach((s, idx) => {
            const fac = (tt.faculties && tt.faculties[idx]) ? tt.faculties[idx].name : (tt.faculties && tt.faculties[0] && tt.faculties[0].name) || '';
            // compute end time as start + duration
            const [h, m] = (start || '00:00').split(':').map(x => Number(x));
            const startMin = h * 60 + (m || 0) + (idx * duration); // stagger subjects sequentially
            const endMin = startMin + duration;
            const hh1 = String(Math.floor(startMin / 60)).padStart(2, '0'), mm1 = String(startMin % 60).padStart(2, '0');
            const hh2 = String(Math.floor(endMin / 60)).padStart(2, '0'), mm2 = String(endMin % 60).padStart(2, '0');
            rows.push({
              date,
              time: `${hh1}:${mm1} - ${hh2}:${mm2}`,
              subject: s.name || s,
              faculty: fac || '',
              section: tt.section || '',
              room: tt.room || '',
              createdAt: tt._createdAt || ''
            });
          });
        } else {
          rows.push({
            date,
            time: `${start} - ${start}`,
            subject: tt.subjectName || '',
            faculty: (tt.faculties && tt.faculties[0] && tt.faculties[0].name) || '',
            section: tt.section || '',
            room: tt.room || '',
            createdAt: tt._createdAt || ''
          });
        }
      });

      // render table (latest first)
      const thead = `<thead><tr><th>Date</th><th>Time</th><th>Subject</th><th>Faculty</th><th>Section</th><th>Room</th></tr></thead>`;
      const tbody = '<tbody>' + rows.map(r => `<tr>
          <td>${escapeHtml(r.date)}</td>
          <td>${escapeHtml(r.time)}</td>
          <td>${escapeHtml(r.subject)}</td>
          <td>${escapeHtml(r.faculty)}</td>
          <td>${escapeHtml(r.section)}</td>
          <td>${escapeHtml(r.room)}</td>
        </tr>`).join('') + '</tbody>';

      container.innerHTML = `<table>${thead}${tbody}</table>`;
    }

    // reuse escape helper if present, otherwise define
    function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    // render on load
    renderAdminTables();

    // When creating a timetable, push to adminTimetables and re-render (patch create handler)
    // Locate create submit handler defined earlier; we update the success branch to store the created table
    // To ensure compatibility, we monkey-patch the api POST result handling by wrapping openCreateModal's submit success.
    (function patchCreateStore() {
      // original create handler created payload and called api('/api/timetables'...)
      // We'll override api to also store the payload when path POST /api/timetables is called from admin page.
      const origApi = window.api;
      window.api = async function (path, opts) {
        const resp = await origApi(path, opts);
        try {
          if (path.startsWith('/api/timetables') && opts && opts.method === 'POST') {
            // attempt to parse body (it was JSON.stringify(payload))
            let body = {};
            try { body = JSON.parse(opts.body || '{}'); } catch (e) { }
            const id = (resp && resp.data && resp.data.id) ? resp.data.id : 'tt_' + Date.now();
            const stored = Object.assign({}, body, { id, _createdAt: new Date().toISOString() });
            // normalize subjects/faculties arrays if not present
            if (!Array.isArray(stored.subjects) && stored.subjectName) stored.subjects = [{ name: stored.subjectName }];
            if (!Array.isArray(stored.faculties) && stored.faculty) stored.faculties = [{ name: stored.faculty }];
            // add to the top and persist
            window.adminTimetables.unshift(stored);
            try { localStorage.setItem('adminTimetables', JSON.stringify(window.adminTimetables)); } catch (e) { }
            // re-render recent area
            renderAdminTables();
          }
        } catch (e) { console.error('Failed to persist created timetable', e); }
        return resp;
      };
    })();

    // Export admin recent timetables to PDF (white background, black text)
    document.getElementById('exportAdminPdf').addEventListener('click', async (evt) => {
      const btn = evt.currentTarget;
      try {
        btn.disabled = true;
        if (!window.jspdf) { alert('PDF library not available'); btn.disabled = false; return; }
        const { jsPDF } = window.jspdf;

        // Read table DOM
        const table = document.querySelector('#recentContainer table');
        if (!table) { alert('No timetable table to export'); btn.disabled = false; return; }

        // Extract headers and rows from DOM table
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
        const trs = Array.from(table.querySelectorAll('tbody tr'));
        const rows = trs.map(tr => Array.from(tr.children).map(td => td.textContent.trim()));

        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const margin = 40;
        const usableW = pageW - margin * 2;
        const colCount = headers.length || 6;
        const colWidth = Math.floor(usableW / colCount);
        const colWidths = new Array(colCount).fill(colWidth);
        const lineHeight = 18;

        // white background
        pdf.setFillColor(255, 255, 255);
        pdf.rect(0, 0, pageW, pageH, 'F');

        // header text
        pdf.setFontSize(16);
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(0, 0, 0);
        pdf.text('Timelytics — Recent Timetables', margin, margin);
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'normal');
        pdf.text(`Generated: ${new Date().toLocaleString()}`, margin, margin + 16);

        // table header
        let y = margin + 36;
        pdf.setFont('helvetica', 'bold');
        pdf.setFontSize(11);
        let x = margin;
        for (let i = 0; i < headers.length; i++) {
          pdf.text(String(headers[i] || ''), x + 2, y);
          x += colWidths[i] || colWidth;
        }
        y += 8;
        pdf.setDrawColor(0);
        pdf.setLineWidth(0.5);
        pdf.line(margin, y, pageW - margin, y);
        y += 10;

        // table rows
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(10);
        for (const r of rows) {
          const rowHeight = lineHeight;
          if (y + rowHeight > pageH - margin) {
            pdf.addPage();
            pdf.setFillColor(255, 255, 255);
            pdf.rect(0, 0, pageW, pageH, 'F');
            y = margin;
          }
          x = margin;
          for (let i = 0; i < colCount; i++) {
            const cellText = String(r[i] || '');
            const maxWidth = (colWidths[i] || colWidth) - 6;
            const split = pdf.splitTextToSize(cellText, maxWidth);
            pdf.text(split, x + 2, y + 10);
            x += (colWidths[i] || colWidth);
          }
          y += rowHeight;
          pdf.setDrawColor(220);
          pdf.setLineWidth(0.3);
          pdf.line(margin, y, pageW - margin, y);
        }

        pdf.save(`Admin_Timetables_${new Date().toISOString().slice(0, 10)}.pdf`);
      } catch (err) {
        console.error(err);
        alert('Failed to generate PDF');
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>

</html>